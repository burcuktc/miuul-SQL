--MIUUL SQL FLO SORULARI
--SORU 1 Customers isimli bir veritabanıve verilen veri setindeki değişkenleri içerecekFLO isimli bir tablo oluşturunuz.
CREATE DATABASE CUSTOMERS
use CUSTOMERS
CREATE TABLE FLO (
	master_id							VARCHAR(50),
	order_channel						VARCHAR(50),
	last_order_channel					VARCHAR(50),
	first_order_date					DATE,
	last_order_date						DATE,
	last_order_date_online				DATE,
	last_order_date_offline				DATE,
	order_num_total_ever_online			INT,
	order_num_total_ever_offline		INT,
	customer_value_total_ever_offline	FLOAT,
	customer_value_total_ever_online	FLOAT,
	interested_in_categories_12			VARCHAR(50),
	store_type							VARCHAR(10)
);

SELECT * FROM FLO
--SORU 2: Kaç farklı müşterinin alışveriş yaptığını gösterecek sorguyu yazınız.
SELECT COUNT(DISTINCT (master_id)) AS DISTINCT_KISI_SAYISI from FLO

--SORU 3: Toplam yapılan alışveriş sayısı ve ciroyu getirecek sorguyu yazınız.
 select 
 SUM(order_num_total_ever_online+order_num_total_ever_offline) as toplam_alisveris_sayisi,
 round(SUM(customer_value_total_ever_offline+customer_value_total_ever_online), 2) AS toplam_ciro 
 FROM FLO

 --SORU 4:  Alışveriş başına ortalama ciroyu getirecek sorguyu yazınız. 

SELECT
ROUND(SUM(customer_value_total_ever_offline+customer_value_total_ever_online)/SUM(order_num_total_ever_online+order_num_total_ever_offline),2) from FLO 

--SORU 5: En son alışverişyapılan kanal (last_order_channel) üzerinden yapılan alışverişlerin toplam ciro ve alışveriş sayılarını getirecek sorguyu yazınız.
SELECT
last_order_channel as son_alisveris_kanali, 
SUM(customer_value_total_ever_offline+customer_value_total_ever_online) as toplam_ciro, 
SUM(order_num_total_ever_online+order_num_total_ever_offline) as toplam_alisveris_sayisi
FROM FLO GROUP BY last_order_channel

--SORU 6: Store type kırılımında elde edilen toplam ciroyu getiren sorguyu yazınız.
SELECT store_type as store_type,
SUM(customer_value_total_ever_offline+customer_value_total_ever_online) as toplam_ciro
FROM FLO GROUP BY store_type

--SORU 7: Yıl kırılımında alışveriş sayılarını getirecek sorguyu yazınız (Yıl olarak müşterinin ilk alışveriş tarihi (first_order_date) yılını baz alınız)
SELECT
YEAR(first_order_date) YIL,
SUM(order_num_total_ever_offline+order_num_total_ever_online) SIPARİS_SAYISI
FROM FLO group by year(first_order_date) order by 2 desc

--SORU 8: En son alışveriş yapılan kanal kırılımında alışveriş başına ortalama ciroyu hesaplayacak sorguyu yazınız.
SELECT
last_order_channel en_son_kanal,
ROUND(SUM(customer_value_total_ever_offline + customer_value_total_ever_online) / SUM(order_num_total_ever_offline + order_num_total_ever_online),2) AS VERIMLILIK
FROM FLO
GROUP BY last_order_channel


--SORU 9: Son 12 ayda en çok ilgi gören kategoriyi getiren sorguyu yazınız.
select * from FLO
SELECT  interested_in_categories_12,
count (*) FREKANS_BILGISI
from FLO
GROUP BY interested_in_categories_12
order by 2 desc

--SORU 10:  En çok tercih edilen store_typebilgisini getiren sorguyu yazınız.
SELECT top 1
store_type,
count(*) FREKANS_BILGISI
FROM FLO
group by store_type 
ORDER BY 2 DESC

--SORU 11: En son alışveriş yapılan kanal (last_order_channel) bazında, en çok ilgi gören kategoriyi ve bu kategoriden ne kadarlık alışveriş yapıldığını getiren sorguyu yazınız.
SELECT DISTINCT last_order_channel,
(
	SELECT top 1 interested_in_categories_12
	FROM FLO  WHERE last_order_channel=f.last_order_channel
	group by interested_in_categories_12
	order by 
	SUM(order_num_total_ever_online+order_num_total_ever_offline) desc 
),
(
	SELECT top 1 SUM(order_num_total_ever_online+order_num_total_ever_offline)
	FROM FLO  WHERE last_order_channel=f.last_order_channel
	group by interested_in_categories_12
	order by 
	SUM(order_num_total_ever_online+order_num_total_ever_offline) desc 
)
FROM FLO F
